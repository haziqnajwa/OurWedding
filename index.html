<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Our Wedding</title>
  <link rel="stylesheet" href="style.css" />

  <link rel="preload" as="image" href="opening.webp">
  <link rel="preload" as="video" href="opening.webm" type="video/webm">
  <link rel="preload" as="image" href="card_bg.webp">
</head>

<body class="locked">
  <audio id="bgMusic" loop>
    <source src="music.mp3" type="audio/mpeg" />
  </audio>

  <button id="musicToggle" class="musicBtn" aria-label="Toggle music">ðŸ”Š</button>

  <!-- OPENING STAGE -->
  <section id="openingSection" class="openingSection">
    <div class="stage">
      <!-- opening.webp -->
      <div id="openingCover" class="openingCover">
        <img class="stageMedia" src="opening.webp" alt="Opening cover" />
        <button id="openHit" class="openHit" aria-label="Tap seal to open">
          <span class="tapText">Tap seal to open</span>
        </button>
      </div>

      <!-- opening.webm -->
      <video id="openingVideo" class="stageMedia hidden" playsinline webkit-playsinline preload="metadata">
        <source src="opening.webm" type="video/webm" />
      </video>
    </div>
  </section>

  <!-- MAIN CONTENT (snap slides) -->
  <main id="mainContent" class="slides lockedContent">

    <!-- SLIDE 1: CARD BG + FLIP CARD -->
    <section class="slide">
      <div class="stage">
        <img class="stageMedia" src="card_bg.webp" alt="Card background" />
        <div class="overlay">

          <!-- SLOT MATCHES YOUR RED RECTANGLE EXACTLY -->
          <div class="cardSlot">
            <div class="flipWrap" id="flipWrap" role="button" tabindex="0" aria-label="Flip card">
              <div class="flipper" id="flipper">
                <div class="face front">
                  <img src="card_front.webp" alt="Front card">
                </div>
                <div class="face back">
                  <img src="card_back.webp" alt="Back card">
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- SLIDE 2: RSVP -->
    <section class="slide">
      <div class="stage">
        <img class="stageMedia" src="rsvp.webp" alt="RSVP" />
        <div class="overlay">
          <div class="rsvpOverlay">
            <a class="rsvpBtn"
               href="https://maps.app.goo.gl/dcHFg6xttDfwuXhg6"
               target="_blank" rel="noopener">Google Map</a>

            <a class="rsvpBtn"
               href="https://docs.google.com/forms/d/e/1FAIpQLSfBWe5IBelfTU7LKJhVfb5zdgDtQ7D1xK-jmd0pqqEJ1QBq4A/viewform"
               target="_blank" rel="noopener">RSVP</a>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 3: COUNTDOWN -->
    <section class="slide">
      <div class="stage">
        <img class="stageMedia" src="countdown.webp" alt="Countdown" />
        <div class="overlay">
          <div class="countdownOverlay">
            <div id="countdown" class="countdownText">Loadingâ€¦</div>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 4: GALLERY -->
    <section class="slide">
      <div class="stage">
        <img class="stageMedia" src="gallery.webp" alt="Gallery frame" />
        <div class="overlay">
          <div class="galleryOverlay">
            <button class="galleryNav" id="prevBtn" aria-label="Previous">â€¹</button>

            <div class="galleryViewport" id="galleryViewport">
              <div class="galleryTrack" id="galleryTrack">
                <div class="gSlide"><img src="gallery1.webp" alt="Gallery 1"></div>
                <div class="gSlide"><img src="gallery2.webp" alt="Gallery 2"></div>
                <div class="gSlide"><img src="gallery3.webp" alt="Gallery 3"></div>
                <div class="gSlide"><img src="gallery4.webp" alt="Gallery 4"></div>
              </div>
            </div>

            <button class="galleryNav" id="nextBtn" aria-label="Next">â€º</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 5: DOA (typewriter) -->
    <section class="slide">
      <div class="stage">
        <img class="stageMedia" src="doa_bg.webp" alt="Doa" />
        <div class="overlay">
          <div class="doaOverlay">
            <div id="doaType" class="doaType"
                 data-text="(30:21) And of His signs is that He created for you from yourselves mates that you may find tranquility in them;
and He placed between you affection and mercy. Verily in that are signs for those who reflect.

(7:189) It is He who created you from one soul and created from it its mate that he might dwell in security with her;
And when he covers her, she carries a light burden and continues therein;
And when it becomes heavy, they both invoke Allah, their Lord, â€œIf You should give us a good [child], we will surely be among the grateful.â€">
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script>
    const body = document.body;

    const openingSection = document.getElementById("openingSection");
    const openingCover   = document.getElementById("openingCover");
    const openingVideo   = document.getElementById("openingVideo");
    const openHit        = document.getElementById("openHit");

    const mainContent = document.getElementById("mainContent");

    const music    = document.getElementById("bgMusic");
    const musicBtn = document.getElementById("musicToggle");

    let opened = false;

    openHit.addEventListener("click", async () => {
      if (opened) return;
      opened = true;

      // Start music after user gesture
      try { await music.play(); } catch (e) {}

      // Cover -> Video
      openingCover.classList.add("hidden");
      openingVideo.classList.remove("hidden");

      try { await openingVideo.play(); }
      catch (e) {
        openingVideo.classList.add("hidden");
        openingCover.classList.remove("hidden");
        opened = false;
      }
    });

    openingVideo.addEventListener("ended", () => {
      openingSection.style.display = "none";
      body.classList.remove("locked");
      mainContent.classList.remove("lockedContent");

      // Start exactly at slide 1
      window.scrollTo({ top: 0, left: 0, behavior: "auto" });

      initDoaTyping();
    });

    // Music toggle button
    musicBtn.addEventListener("click", async () => {
      if (music.paused) {
        try { await music.play(); } catch(e) {}
        musicBtn.textContent = "ðŸ”Š";
      } else {
        music.pause();
        musicBtn.textContent = "ðŸ”‡";
      }
    });

    // Flip card
    const flipper = document.getElementById("flipper");
    const flipWrap = document.getElementById("flipWrap");

    function toggleFlip(){ flipper.classList.toggle("flip"); }

    flipWrap.addEventListener("click", toggleFlip);
    flipWrap.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggleFlip();
      }
    });

    // Countdown (2 May 2026 11:00 AM GMT+8)
    const countdownEl = document.getElementById("countdown");
    const eventDate = new Date("2026-05-02T11:00:00+08:00");

    function tick(){
      const now = new Date();
      const diff = eventDate - now;
      if (diff <= 0) { countdownEl.textContent = "Itâ€™s today!"; return; }

      const s = Math.floor(diff / 1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss = s % 60;

      countdownEl.textContent = `${d}d ${h}h ${m}m ${ss}s`;
    }

    tick();
    setInterval(tick, 1000);

    // Gallery swipe + buttons
    const track = document.getElementById("galleryTrack");
    const viewport = document.getElementById("galleryViewport");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const total = track.children.length;

    let idx = 0;

    function go(i){
      idx = (i + total) % total;
      track.style.transform = `translateX(-${idx * 100}%)`;
    }

    prevBtn.addEventListener("click", () => go(idx - 1));
    nextBtn.addEventListener("click", () => go(idx + 1));

    let startX = 0, dragging = false;
    viewport.addEventListener("pointerdown", (e) => {
      dragging = true;
      startX = e.clientX;
      viewport.setPointerCapture(e.pointerId);
    });

    viewport.addEventListener("pointerup", (e) => {
      if (!dragging) return;
      dragging = false;

      const dx = e.clientX - startX;
      if (Math.abs(dx) > 45) go(dx < 0 ? idx + 1 : idx - 1);
    });

    // Doa: typewriter (letters 1-by-1)
    function initDoaTyping(){
      const box = document.getElementById("doaType");
      if (!box) return;

      const fullText = box.dataset.text || "";
      let started = false;

      function typeWriter(){
        if (started) return;
        started = true;

        box.textContent = "";
        let i = 0;
        const speed = 18; // ms per character

        const timer = setInterval(() => {
          box.textContent += fullText[i] ?? "";
          i++;
          if (i >= fullText.length) clearInterval(timer);
        }, speed);
      }

      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;
          typeWriter();
          io.disconnect();
        });
      }, { threshold: 0.55 });

      io.observe(box);
    }
  </script>
</body>
</html>
